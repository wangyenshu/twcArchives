name: Archives TWC Plugins and Themes

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and Run Legacy Scripts
        id: legacy_script
        run: |
          # The script will now write all its output to the root of the workspace.
          docker run --rm \
            --workdir /github/workspace \
            -v "${{ github.workspace }}:/github/workspace" \
            -e GITHUB_REPOSITORY=${{ github.repository }} \
            -e VERSION=0.1 \
            ubuntu:16.04 bash -c "
              set -e

              # --- STAGE 1: Install Dependencies (as root) ---
              apt-get update && \
              apt-get install -y --no-install-recommends \
                wget \
                git \
                jq \
                software-properties-common \
                build-essential
              apt-add-repository ppa:brightbox/ruby-ng && \
              apt-get update && \
              apt-get install -y --no-install-recommends \
                ruby1.8 \
                ruby1.8-dev && \
              apt-get clean && \
              rm -rf /var/lib/apt/lists/*
              
              # --- STAGE 2: Execute Legacy Script as a non-root user ---
              addgroup --gid $(id -g) runnergroup
              adduser --uid $(id -u) --ingroup runnergroup --disabled-password --gecos '' runner
              
              su runner -c \"
                set -e
                
                if [ ! -d \\\"cooker\\\" ]; then
                    git clone https://github.com/TiddlyWiki/cooker.git
                fi

                # Output directories are now in the root of the workspace
                mkdir -p split_file
                mkdir -p plugins
                mkdir -p themes

                master_json_output=\\\"[]\\\"
                
                while read url; do
                  if [ -z \\\"\\\$url\\\" ]; then
                    continue
                  fi
                  sanitized_url=\\\$(echo \\\"\\\$url\\\" | sed -E 's/^https?:\/\///' | sed 's/[^a-zA-Z0-9]/_/g')

                  output_html=\\\"\\\${sanitized_url}.html\\\"
                  echo \\\"Processing URL: \\\$url\\\"
                  wget --no-check-certificate -O \\\"\\\${output_html}\\\" \\\"\\\$url\\\"
                  
                  ( cd cooker && ruby ginsu.rb \\\"../\\\${output_html}\\\" -s -d \\\"../split_file\\\" -c UTF-8 )
                  
                  plugins_dir=\\\"split_file/\\\${sanitized_url}.html.0/plugins\\\"
                  if [ -d \\\"\\\$plugins_dir\\\" ]; then
                    echo \\\"Plugins directory exists, copying and generating JSON...\\\"
                    # Output is now copied to the plugins/ directory in the root
                    mkdir -p \\\"plugins/\\\${sanitized_url}\\\"
                    cp -r \\\"\\\$plugins_dir\\\"/* \\\"plugins/\\\${sanitized_url}\\\"
                    plugins_json_output=\\\"[]\\\"
                    while read -r line; do
                      filename=\\\$(echo \\\"\\\$line\\\" | sed -E 's/^tiddler: (.*)\$/\1/')
                      description=\\\$(awk -F'|' '/^\|Description:/{print \$3; exit}' \\\"\\\${plugins_dir}/\\\${filename}\\\")
                      description=\\\$(echo \\\"\\\$description\\\" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*\$//')
                      if [ -z \\\"\\\$description\\\" ]; then
                        description=\\\"\$filename\\\"
                      fi
                      # UPDATED URL: 'commit/' prefix has been removed
                      full_url=\\\"https://github.com/\\\${GITHUB_REPOSITORY}/blob/twcArchives/plugins/\\\${sanitized_url}/\\\${filename}\\\"
                      plugins_json_output=\\\$(echo \\\"\\\$plugins_json_output\\\" | jq --arg url \\\"\\\$full_url\\\" --arg desc \\\"\\\$description\\\" '. += [{url: \\\$url, description: \\\$desc}]')
                    done < \\\"\\\${plugins_dir}/split.recipe\\\"
                    # UPDATED URL: 'commit/' prefix has been removed
                    json_file_url=\\\"https://github.com/\\\${GITHUB_REPOSITORY}/blob/twcArchives/plugins/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"|Source|\\\${json_file_url}|\\\" > \\\"plugins/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"|Version|\\\${VERSION}|\\\" >> \\\"plugins/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"//{{{\\\" >> \\\"plugins/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"\\\$plugins_json_output\\\" >> \\\"plugins/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"//}}}\\\" >> \\\"plugins/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    # UPDATED URL: 'commit/' prefix has been removed
                    master_json_url=\\\"https://github.com/\\\${GITHUB_REPOSITORY}/blob/twcArchives/plugins/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    master_json_output=\\\$(echo \\\"\\\$master_json_output\\\" | jq --arg url \\\"\\\$master_json_url\\\" --arg desc \\\"\\\$sanitized_url\\\" '. += [{url: \\\$url, description: \\\$desc, type: \\\"collection\\\"}]')
                  else
                    echo \\\"Plugins directory does not exist, skipping.\\\"
                  fi
                  themes_dir=\\\"split_file/\\\${sanitized_url}.html.0/themes\\\"
                  if [ -d \\\"\\\$themes_dir\\\" ]; then
                    echo \\\"Themes directory exists, copying and generating JSON...\\\"
                    # Output is now copied to the themes/ directory in the root
                    mkdir -p \\\"themes/\\\${sanitized_url}\\\"
                    cp -r \\\"\\\$themes_dir\\\"/* \\\"themes/\\\${sanitized_url}\\\"
                    themes_json_output=\\\"[]\\\"
                    while read -r line; do
                      filename=\\\$(echo \\\"\\\$line\\\" | sed -E 's/^tiddler: (.*)\$/\1/')
                      description=\\\$(awk -F'|' '/^\|Description:/{print \$3; exit}' \\\"\\\${themes_dir}/\\\${filename}\\\")
                      description=\\\$(echo \\\"\\\$description\\\" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*\$//')
                      if [ -z \\\"\\\$description\\\" ]; then
                        description=\\\"\$filename\\\"
                      fi
                      # UPDATED URL: 'commit/' prefix has been removed
                      full_url=\\\"https://github.com/\\\${GITHUB_REPOSITORY}/blob/twcArchives/themes/\\\${sanitized_url}/\\\${filename}\\\"
                      themes_json_output=\\\$(echo \\\"\\\$themes_json_output\\\" | jq --arg url \\\"\\\$full_url\\\" --arg desc \\\"\\\$description\\\" '. += [{url: \\\$url, description: \\\$desc}]')
                    done < \\\"\\\${themes_dir}/split.recipe\\\"
                    # UPDATED URL: 'commit/' prefix has been removed
                    json_file_url=\\\"https://github.com/\\\${GITHUB_REPOSITORY}/blob/twcArchives/themes/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"|Source|\\\${json_file_url}|\\\" > \\\"themes/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"|Version|\\\${VERSION}|\\\" >> \\\"themes/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"//{{{\\\" >> \\\"themes/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"\\\$themes_json_output\\\" >> \\\"themes/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    echo \\\"//}}}\\\" >> \\\"themes/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    # UPDATED URL: 'commit/' prefix has been removed
                    master_json_url=\\\"https://github.com/\\\${GITHUB_REPOSITORY}/blob/twcArchives/themes/\\\${sanitized_url}/\\\${sanitized_url}.txt\\\"
                    master_json_output=\\\$(echo \\\"\\\$master_json_output\\\" | jq --arg url \\\"\\\$master_json_url\\\" --arg desc \\\"\\\$sanitized_url\\\" '. += [{url: \\\$url, description: \\\$desc, type: \\\"collection\\\"}]')
                  else
                    echo \\\"Themes directory does not exist, skipping.\\\"
                  fi
                  rm -rf split_file/*
                done < systemServer.txt
                # UPDATED URL: 'commit/' prefix has been removed
                master_file_url=\\\"https://github.com/\\\${GITHUB_REPOSITORY}/blob/twcArchives/twcArchives.txt\\\"
                echo \\\"|Source|\\\${master_file_url}|\\\" > \\\"twcArchives.txt\\\"
                echo \\\"|Version|\\\${VERSION}|\\\" >> \\\"twcArchives.txt\\\"
                echo \\\"//{{{\\\" >> \\\"twcArchives.txt\\\"
                echo \\\"\\\$master_json_output\\\" >> \\\"twcArchives.txt\\\"
                echo \\\"//}}}\\\" >> \\\"twcArchives.txt\\\"
              \"
            "
      
      - name: Commit and push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        chown -R $(id -u):$(id -g) commit
        cd commit
        git init
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -B twcArchives
        git add .
        git commit -m "Update twcArchives" || echo "No changes to commit"
        git push --force "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" twcArchives
